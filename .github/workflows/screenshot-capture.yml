name: Screenshot Capture

on:
  # DispatcherçµŒç”±ã®å‘¼ã³å‡ºã—ã«å¯¾å¿œ
  workflow_dispatch:
    inputs:
      batch_data:
        description: 'JSON batch data from Dispatcher'
        required: false
        type: string
      batch_id:
        description: 'Batch ID from Dispatcher'
        required: false
        type: string
      limit:
        description: 'Number of pets to process'
        required: false
        default: '10'
        type: string
      # trigger_conversion removed - now handled by Conversion Queue

jobs:
  capture-screenshots:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Record workflow start
        id: workflow-start
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST "${API_URL}/api/workflow/start" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "{
              \"syncType\": \"screenshot\",
              \"metadata\": {
                \"batchId\": \"${{ github.event.inputs.batch_id }}\",
                \"githubRunId\": ${{ github.run_id }},
                \"githubRunUrl\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                \"workflowFile\": \"screenshot-capture.yml\",
                \"limit\": \"${{ github.event.inputs.limit || '10' }}\"
              }
            }")

          WORKFLOW_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "workflow_id=${WORKFLOW_ID}" >> $GITHUB_OUTPUT
          echo "âœ… Workflow started with ID: ${WORKFLOW_ID}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: |
          npm install
          npm install playwright

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Prepare pets data
        id: prepare-pets
        continue-on-error: true
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
        run: |
          # DispatcherçµŒç”±ã®å ´åˆ
          if [ -n "${{ github.event.inputs.batch_data }}" ]; then
            echo 'Processing data from Dispatcher...'
            echo '${{ github.event.inputs.batch_data }}' > pets_to_process.json
            PET_COUNT=$(echo '${{ github.event.inputs.batch_data }}' | jq 'length')

            # ãƒãƒƒãƒIDã‹ã‚‰æœŸå¾…å€¤ã‚’å–å¾—
            if [ -n "${{ github.event.inputs.batch_id }}" ]; then
              echo "Fetching expected count from crawler state..."
              CRAWLER_STATE=$(curl -s "${API_URL}/api/crawler/get-state/${{ github.event.inputs.batch_id }}" \
                -H "X-API-Key: ${API_KEY}")

              if echo "$CRAWLER_STATE" | jq -e '.checkpoint' > /dev/null; then
                EXPECTED_COUNT=$(echo "$CRAWLER_STATE" | jq -r '.checkpoint.totalFetched')
                echo "Expected count from crawler: ${EXPECTED_COUNT}"
                echo "expected_count=${EXPECTED_COUNT}" >> $GITHUB_OUTPUT

                if [ "$PET_COUNT" != "$EXPECTED_COUNT" ]; then
                  echo "âš ï¸ WARNING: Count mismatch! Expected: ${EXPECTED_COUNT}, Actual: ${PET_COUNT}"
                fi
              fi
            fi
          else
            # æ‰‹å‹•å®Ÿè¡Œï¼ˆAPIã‹ã‚‰å–å¾—ï¼‰
            echo 'Fetching data from API...'
            PETS_JSON=$(curl -s "${API_URL}/api/stats" | \
              jq '[.data.missingImages[0:${{ github.event.inputs.limit || 10 }}] |
                  .[] | {id: .id, name: .name, sourceUrl: .sourceUrl, type: .type}]')
            echo "$PETS_JSON" > pets_to_process.json
            PET_COUNT=$(echo "$PETS_JSON" | jq 'length')
          fi

          echo "pet_count=${PET_COUNT}" >> $GITHUB_OUTPUT
          echo "Found ${PET_COUNT} pets to process"

      - name: Capture screenshots
        id: capture-screenshots
        if: steps.prepare-pets.outputs.pet_count > 0
        continue-on-error: true
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
          PUBLIC_API_KEY: ${{ secrets.BUDDIES_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ã‚’å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          BATCH_ID="${{ github.event.inputs.batch_id || format('capture-{0}', github.run_id) }}"
          node scripts/dispatcher/screenshot-capture.js \
            --batch-file="pets_to_process.json" \
            --batch-id="${BATCH_ID}" \
            --max-retries=3

          # æˆåŠŸã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ãƒšãƒƒãƒˆIDã‚’ä¿å­˜
          if [ -f "scripts/logs/capture-results.json" ]; then
            SUCCESS_COUNT=$(cat scripts/logs/capture-results.json | jq '[.results[] | select(.success)] | length')
            echo "screenshot_success_count=${SUCCESS_COUNT}" >> $GITHUB_OUTPUT
          else
            echo "screenshot_success_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Capture additional screenshots if capacity available
        id: capture-additional
        if: steps.prepare-pets.outputs.pet_count > 0
        continue-on-error: true
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
          PUBLIC_API_KEY: ${{ secrets.BUDDIES_API_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          # å‡¦ç†æ¸ˆã¿æ•°ã¨limitã‚’æ¯”è¼ƒ
          PROCESSED_COUNT=${{ steps.prepare-pets.outputs.pet_count }}
          LIMIT=${{ github.event.inputs.limit || 10 }}
          REMAINING=$((LIMIT - PROCESSED_COUNT))

          if [ $REMAINING -gt 0 ]; then
            echo "ğŸ“Š Capacity available: $REMAINING slots"

            # å¤±æ•—ã—ãŸãƒšãƒƒãƒˆIDã‚’æŠ½å‡ºï¼ˆã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆä½œæˆï¼‰
            SKIP_IDS="[]"
            if [ -f "scripts/logs/capture-results.json" ]; then
              SKIP_IDS=$(jq '[.results[] | select(.success == false) | .pet_id]' scripts/logs/capture-results.json)
            fi

            # APIã‹ã‚‰è¿½åŠ ãƒšãƒƒãƒˆã‚’å–å¾—ï¼ˆçŠ¬ã¨çŒ«ã‚’å‡ç­‰ã«ï¼‰
            DOGS_LIMIT=$((REMAINING / 2))
            CATS_LIMIT=$((REMAINING - DOGS_LIMIT))

            # çŠ¬ã®è¿½åŠ å–å¾—
            if [ $DOGS_LIMIT -gt 0 ]; then
              curl -s "${API_URL}/api/stats/dogs/missing-screenshots?limit=${DOGS_LIMIT}" \
                -H "X-API-Key: ${API_KEY}" | jq '.data.pets // []' > additional_dogs.json
            else
              echo "[]" > additional_dogs.json
            fi

            # çŒ«ã®è¿½åŠ å–å¾—
            if [ $CATS_LIMIT -gt 0 ]; then
              curl -s "${API_URL}/api/stats/cats/missing-screenshots?limit=${CATS_LIMIT}" \
                -H "X-API-Key: ${API_KEY}" | jq '.data.pets // []' > additional_cats.json
            else
              echo "[]" > additional_cats.json
            fi

            # è¿½åŠ ãƒšãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆå¤±æ•—ã—ãŸãƒšãƒƒãƒˆã‚’é™¤å¤–ï¼‰
            jq -s --argjson skip "$SKIP_IDS" \
              '(.[0] + .[1]) | map(select(.id as $id | $skip | index($id) | not))' \
              additional_dogs.json additional_cats.json > additional_pets.json

            ADDITIONAL_COUNT=$(jq 'length' additional_pets.json)

            if [ $ADDITIONAL_COUNT -gt 0 ]; then
              echo "ğŸ“¸ Processing $ADDITIONAL_COUNT additional pets..."

              # è¿½åŠ ãƒšãƒƒãƒˆã‚’å‡¦ç†ï¼ˆåŒã˜ããƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
              BATCH_ID="${{ github.event.inputs.batch_id || format('capture-{0}', github.run_id) }}"
              node scripts/dispatcher/screenshot-capture.js \
                --batch-file="additional_pets.json" \
                --batch-id="${BATCH_ID}-additional" \
                --max-retries=3 \
                --append-results=true

              # æ›´æ–°ã•ã‚ŒãŸæˆåŠŸæ•°ã‚’ä¿å­˜
              if [ -f "scripts/logs/capture-results.json" ]; then
                TOTAL_SUCCESS=$(cat scripts/logs/capture-results.json | jq '[.results[] | select(.success)] | length')
                echo "total_success_count=${TOTAL_SUCCESS}" >> $GITHUB_OUTPUT
              fi
            else
              echo "â„¹ï¸ No additional pets available for processing"
            fi
          else
            echo "âœ… Batch limit reached, no additional processing needed"
          fi

      - name: Update hasJpeg flags in database
        if: steps.capture-screenshots.outputs.screenshot_success_count > 0
        continue-on-error: true
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
        run: |
          # æˆåŠŸã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ãƒšãƒƒãƒˆæƒ…å ±ã‚’æŠ½å‡º
          SUCCESSFUL_PETS=$(cat scripts/logs/capture-results.json | jq '[.results[] | select(.success) | {
            id: .pet_id,
            type: .pet_type
          }]')

          PETS_COUNT=$(echo "$SUCCESSFUL_PETS" | jq 'length')

          if [ "$PETS_COUNT" -gt 0 ]; then
            echo "ğŸ“¤ Updating hasJpeg flag for $PETS_COUNT pets in database"

            # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¦hasJpegãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
            UPDATE_RESPONSE=$(curl -s -X PUT "${API_URL}/api/pets/update-image-flags" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${API_KEY}" \
              -d "{
                \"pets\": $SUCCESSFUL_PETS,
                \"flagType\": \"hasJpeg\"
              }")

            echo "Update response: $UPDATE_RESPONSE"

            if echo "$UPDATE_RESPONSE" | jq -e '.success' > /dev/null; then
              UPDATED_COUNT=$(echo "$UPDATE_RESPONSE" | jq -r '.data.updated')
              echo "âœ… Successfully updated hasJpeg flag for $UPDATED_COUNT pets"
            else
              echo "âš ï¸ Failed to update hasJpeg flags in database"
              echo "$UPDATE_RESPONSE"
            fi
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-logs-${{ github.run_id }}
          path: |
            scripts/logs/
            pets_to_process.json
          retention-days: 7

      - name: Send screenshot results to API for conversion
        if: steps.prepare-pets.outputs.pet_count > 0
        continue-on-error: true
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
        run: |
          # çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          RESULTS=$(cat scripts/logs/capture-results.json)

          # APIãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ› (petsé…åˆ—: {id, type, screenshotKey})
          PETS_FOR_CONVERSION=$(echo "$RESULTS" | jq '[.results[] | select(.success) | {
            id: .pet_id,
            type: .pet_type,
            screenshotKey: .screenshotKey
          }]')

          SUCCESS_COUNT=$(echo "$RESULTS" | jq '[.results[] | select(.success)] | length')
          BATCH_ID=$(echo "$RESULTS" | jq -r '.batchId')

          if [ "$SUCCESS_COUNT" -gt 0 ]; then
            echo "ğŸ“¤ Sending screenshot results to API for conversion ($SUCCESS_COUNT successful screenshots)"

            # APIã®conversionã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€ä¿¡ (APIãŒDispatcherã«è»¢é€)
            RESPONSE=$(curl -s -X POST "${API_URL}/api/conversion/screenshot" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${API_KEY}" \
              -d "{
                \"pets\": $PETS_FOR_CONVERSION,
                \"batchId\": \"$BATCH_ID-conversion\",
                \"source\": \"screenshot-capture\"
              }")

            echo "Response: $RESPONSE"

            if echo "$RESPONSE" | jq -e '.success' > /dev/null; then
              CONVERSION_BATCH_ID=$(echo "$RESPONSE" | jq -r '.batchId // "N/A"')
              CONVERSION_COUNT=$(echo "$RESPONSE" | jq -r '.count // 0')
              echo "âœ… Conversion triggered via API for $CONVERSION_COUNT pets (Batch ID: $CONVERSION_BATCH_ID)"
            else
              echo "âš ï¸ Failed to trigger conversion via API"
              echo "$RESPONSE"
            fi
          else
            echo "â„¹ï¸ No successful screenshots to convert"
          fi

      - name: Update crawler state
        if: steps.prepare-pets.outputs.pet_count > 0 && github.event.inputs.batch_id
        continue-on-error: true
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
        run: |
          # æˆåŠŸã—ãŸãƒšãƒƒãƒˆIDã‚’åé›†
          if [ -f "scripts/logs/capture-results.json" ]; then
            SUCCESS_IDS=$(cat scripts/logs/capture-results.json | \
              jq -c '[.results[] | select(.success) | .pet_id]')
            SUCCESS_COUNT=$(echo "$SUCCESS_IDS" | jq 'length')

            echo "ğŸ“¤ Updating crawler state for batch ${{ github.event.inputs.batch_id }}"

            # crawler_statesã‚’æ›´æ–°
            UPDATE_RESPONSE=$(curl -s -X POST "${API_URL}/api/crawler/update-state" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${API_KEY}" \
              -d "{
                \"batchId\": \"${{ github.event.inputs.batch_id }}\",
                \"stage\": \"screenshot\",
                \"successCount\": ${SUCCESS_COUNT},
                \"successIds\": ${SUCCESS_IDS}
              }")

            if echo "$UPDATE_RESPONSE" | jq -e '.success' > /dev/null; then
              echo "âœ… Successfully updated crawler state"
            else
              echo "âš ï¸ Failed to update crawler state"
              echo "$UPDATE_RESPONSE"
            fi
          fi

      - name: Summary
        if: steps.prepare-pets.outputs.pet_count > 0
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
        run: |
          # æœ€çµ‚çµæœã‚’èª­ã¿è¾¼ã¿
          if [ -f "scripts/logs/capture-results.json" ]; then
            TOTAL_PROCESSED=$(jq '.totalProcessed' scripts/logs/capture-results.json)
            TOTAL_SUCCESS=$(jq '.successful' scripts/logs/capture-results.json)
            TOTAL_FAILED=$(jq '.failed' scripts/logs/capture-results.json)

            echo "âœ… Screenshot capture completed"
            echo "ğŸ“Š Total processed: ${TOTAL_PROCESSED}"
            echo "  âœ… Successful: ${TOTAL_SUCCESS}"
            echo "  âŒ Failed: ${TOTAL_FAILED}"

            # ãƒªãƒˆãƒ©ã‚¤çµ±è¨ˆ
            RETRIED_COUNT=$(jq '[.results[] | select(.success and .attempts > 1)] | length' scripts/logs/capture-results.json)
            if [ $RETRIED_COUNT -gt 0 ]; then
              echo "  ğŸ”„ Succeeded with retries: ${RETRIED_COUNT}"
            fi

            # è¿½åŠ å‡¦ç†ã®çµ±è¨ˆ
            if [ -n "${{ steps.capture-additional.outputs.total_success_count }}" ]; then
              INITIAL_COUNT=${{ steps.prepare-pets.outputs.pet_count }}
              ADDITIONAL_COUNT=$((TOTAL_PROCESSED - INITIAL_COUNT))
              if [ $ADDITIONAL_COUNT -gt 0 ]; then
                echo "  ğŸ“ˆ Additional pets processed: ${ADDITIONAL_COUNT}"
              fi
            fi
          else
            echo "âœ… Screenshot capture completed for ${{ steps.prepare-pets.outputs.pet_count }} pets"
          fi

          if [ -n "${{ steps.prepare-pets.outputs.expected_count }}" ]; then
            echo "ğŸ“Š Expected from crawler: ${{ steps.prepare-pets.outputs.expected_count }}"
          fi
          echo "ğŸ“¤ Conversion request sent to Dispatcher Queue"

      - name: Record workflow completion
        if: always()
        env:
          API_URL: ${{ secrets.API_URL || 'https://buddies-api.elchika.app' }}
          API_KEY: ${{ secrets.BUDDIES_API_KEY }}
        run: |
          # çµæœã‚’é›†è¨ˆ
          if [ -f "scripts/logs/capture-results.json" ]; then
            TOTAL=$(jq '.totalProcessed // 0' scripts/logs/capture-results.json)
            SUCCESS=$(jq '.successful // 0' scripts/logs/capture-results.json)
            FAILED=$(jq '.failed // 0' scripts/logs/capture-results.json)
          else
            TOTAL=0
            SUCCESS=0
            FAILED=0
          fi

          # Artifacts URL
          ARTIFACTS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # æˆåŠŸ/å¤±æ•—ã«å¿œã˜ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠ
          if [ "${{ job.status }}" == "success" ]; then
            ENDPOINT="complete"
            PAYLOAD="{
              \"totalRecords\": ${TOTAL},
              \"processedRecords\": ${SUCCESS},
              \"failedRecords\": ${FAILED}
            }"
          else
            ENDPOINT="fail"
            PAYLOAD="{
              \"errorMessage\": \"Workflow failed with status: ${{ job.status }}. Check logs at: ${ARTIFACTS_URL}\"
            }"
          fi

          # APIã«è¨˜éŒ²
          curl -s -X PUT "${API_URL}/api/workflow/${{ steps.workflow-start.outputs.workflow_id }}/${ENDPOINT}" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d "$PAYLOAD"

          echo "âœ… Workflow completion recorded (Status: ${{ job.status }})"
