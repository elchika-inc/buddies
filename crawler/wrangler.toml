# =============================================================================
# PawMatch Crawler Service Configuration
# =============================================================================

# -----------------------------------------------------------------------------
# Base Configuration
# -----------------------------------------------------------------------------
name = "pawmatch-crawler"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# -----------------------------------------------------------------------------
# Default Environment Variables
# -----------------------------------------------------------------------------
[vars]
NODE_ENV = "production"
ALLOWED_ORIGIN = "https://pawmatch-api.elchika.app"
PET_HOME_BASE_URL = "https://www.pet-home.jp"
API_URL = "https://pawmatch-api.elchika.app"
PUBLIC_API_KEY = "b80f83e113c5463a811607a30afd133dbb0b3c39a0eb41ebac716e29eeda27fb"
CRAWLER_API_KEY = "crawler-secret-key-2024"

# -----------------------------------------------------------------------------
# Resource Bindings
# -----------------------------------------------------------------------------

# Service Bindings for internal communication
[[services]]
binding = "API_SERVICE"
service = "pawmatch-api"

# R2 Bucket (Image Storage)
[[r2_buckets]]
binding = "IMAGES_BUCKET"
bucket_name = "pawmatch-images"

# D1 Database (Shared with API)
[[d1_databases]]
binding = "DB"
database_name = "pawmatch-db"
database_id = "b397c3a4-3ee4-4259-b004-6de4488e921f"
migrations_dir = "../database/migrations"

# -----------------------------------------------------------------------------
# Queue Configuration
# -----------------------------------------------------------------------------

# Main Crawler Queue (APIから起動)
[[queues.consumers]]
queue = "pawmatch-crawler-queue"
max_batch_size = 5
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pawmatch-crawler-dlq"
max_concurrency = 2

# Dead Letter Queue for Crawler
[[queues.producers]]
binding = "PAWMATCH_CRAWLER_DLQ"
queue = "pawmatch-crawler-dlq"

# Cat Queue (PetHome)
[[queues.producers]]
binding = "PAWMATCH_CAT_PETHOME_QUEUE"
queue = "pawmatch-cat-pethome-queue"

[[queues.consumers]]
queue = "pawmatch-cat-pethome-queue"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pawmatch-cat-pethome-dlq"
max_concurrency = 1

# Dog Queue (PetHome)
[[queues.producers]]
binding = "PAWMATCH_DOG_PETHOME_QUEUE"
queue = "pawmatch-dog-pethome-queue"

[[queues.consumers]]
queue = "pawmatch-dog-pethome-queue"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pawmatch-dog-pethome-dlq"
max_concurrency = 1

# Dead Letter Queues
[[queues.producers]]
binding = "PAWMATCH_CAT_PETHOME_DLQ"
queue = "pawmatch-cat-pethome-dlq"

[[queues.producers]]
binding = "PAWMATCH_DOG_PETHOME_DLQ"
queue = "pawmatch-dog-pethome-dlq"

# -----------------------------------------------------------------------------
# Triggers
# -----------------------------------------------------------------------------
# Cronトリガーは削除 (APIからDispatcher経由で起動される)

# -----------------------------------------------------------------------------
# Observability
# -----------------------------------------------------------------------------
[observability.logs]
enabled = true

# =============================================================================
# Environment-specific Configurations
# =============================================================================

# -----------------------------------------------------------------------------
# Production Environment
# -----------------------------------------------------------------------------
[env.production]
name = "pawmatch-crawler"

[env.production.vars]
GITHUB_ACTIONS = "true"
NODE_ENV = "production"
ALLOWED_ORIGIN = "https://pawmatch-api.elchika.app"
PET_HOME_BASE_URL = "https://www.pet-home.jp"
API_URL = "https://pawmatch-api.elchika.app"
PUBLIC_API_KEY = "b80f83e113c5463a811607a30afd133dbb0b3c39a0eb41ebac716e29eeda27fb"

# Production Resource Bindings
[[env.production.services]]
binding = "API_SERVICE"
service = "pawmatch-api"

[[env.production.r2_buckets]]
binding = "IMAGES_BUCKET"
bucket_name = "pawmatch-images"

[[env.production.d1_databases]]
binding = "DB"
database_name = "pawmatch-db"
database_id = "b397c3a4-3ee4-4259-b004-6de4488e921f"
migrations_dir = "../database/migrations"

# Production Queue Configuration
[[env.production.queues.producers]]
binding = "PAWMATCH_CAT_PETHOME_QUEUE"
queue = "pawmatch-cat-pethome-queue"

[[env.production.queues.consumers]]
queue = "pawmatch-cat-pethome-queue"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pawmatch-cat-pethome-dlq"
max_concurrency = 1

[[env.production.queues.producers]]
binding = "PAWMATCH_DOG_PETHOME_QUEUE"
queue = "pawmatch-dog-pethome-queue"

[[env.production.queues.consumers]]
queue = "pawmatch-dog-pethome-queue"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pawmatch-dog-pethome-dlq"
max_concurrency = 1

[[env.production.queues.producers]]
binding = "PAWMATCH_CAT_PETHOME_DLQ"
queue = "pawmatch-cat-pethome-dlq"

[[env.production.queues.producers]]
binding = "PAWMATCH_DOG_PETHOME_DLQ"
queue = "pawmatch-dog-pethome-dlq"

# -----------------------------------------------------------------------------
# Development Environment
# -----------------------------------------------------------------------------
[env.development]
name = "pawmatch-crawler-dev"

[env.development.vars]
NODE_ENV = "development"
ALLOWED_ORIGIN = "http://localhost:3004"
PET_HOME_BASE_URL = "https://www.pet-home.jp"
API_URL = "http://localhost:9789"
PUBLIC_API_KEY = "b80f83e113c5463a811607a30afd133dbb0b3c39a0eb41ebac716e29eeda27fb"

# -----------------------------------------------------------------------------
# Local Development Server
# -----------------------------------------------------------------------------
[dev]
port = 9787
inspector_port = 10787